# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# ¬© 2023 Floorp Projects & Contributors

on:
  workflow_call:

jobs:
  win-build:
    runs-on: ubuntu-latest
    steps:
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "lts/*"

    - uses: actions/checkout@v4
      name: Clone üß¨
      with:
        submodules: "recursive"

    - name: Configure sccache
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: setup Rust ü¶Ä
      run: |
        #packed_simd build error
        rustup toolchain install 1.77.2
        rustup target add x86_64-pc-windows-msvc

        #? https://github.com/mozilla/sccache#known-caveats
        export CARGO_INCREMENTAL=0

    - name: Allocate swap
      run: |
        echo Before:
        free -h
        df -h
        
        echo
        echo
        
        sudo swapoff /mnt/swapfile
        sudo rm /mnt/swapfile
        sudo fallocate -l 10G /mnt/swapfile
        sudo chmod 600 /mnt/swapfile
        sudo mkswap /mnt/swapfile
        sudo swapon /mnt/swapfile

        sudo apt autoremove -y
        sudo apt clean
        sudo rm -rf  ./git
        sudo rm -rf /home/linuxbrew
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/lib/node_modules
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo rm -rf /etc/apache2
        sudo rm -rf /etc/nginx
        sudo rm -rf /usr/local/share/chrome_driver
        sudo rm -rf /usr/local/share/edge_driver
        sudo rm -rf /usr/local/share/gecko_driver
        sudo rm -rf /usr/share/java
        sudo rm -rf /usr/share/miniconda
        sudo rm -rf /usr/local/share/vcpkg


        echo
        echo
        
        echo After:
        free -h
        df -h

    - name: Setup ü™õ
      run: |
        cd $GITHUB_WORKSPACE

        cp ./.github/workflows/mozconfigs/win64.mozconfig mozconfig

        sudo apt install msitools -y

        ./mach --no-interactive bootstrap --application-choice browser

    - name: Mach Configure
      run: |
        ./mach configure

    - name: Build üî®
      run: |
        ./mach build

    # Publish START
    - name: compress zstd
      run: |
        rsync -aqL --progress obj-x86_64-pc-windows-msvc/dist/bin/ ~/output
        cd ~/output
        tar -I "zstd -T0 -10" -cf ~/noraneko.tar.zst .

    - name: Publish PackageüéÅ
      uses: actions/upload-artifact@v4
      with:
        name: noraneko-win-amd64-zstd
        compression-level: 0
        path: ~/noraneko.tar.zst
    # Publish END
